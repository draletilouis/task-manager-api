# Railway Deployment Guide for Kazi

This guide will help you deploy the Kazi task management application to Railway.

## Prerequisites

- Railway account (sign up at https://railway.app)
- GitHub repository connected to Railway
- Database ready (Railway provides PostgreSQL)

## Architecture

This is a monorepo with two services:
- **API Service**: Express.js backend with Prisma ORM
- **Web Service**: React frontend built with Vite

## Deployment Steps

### 1. Create Railway Project

1. Go to https://railway.app/new
2. Select "Deploy from GitHub repo"
3. Choose your `Kazi` repository
4. Railway will create a project

### 2. Set Up PostgreSQL Database

1. In your Railway project, click "+ New"
2. Select "Database" → "PostgreSQL"
3. Railway will provision a PostgreSQL database
4. Copy the `DATABASE_URL` connection string (it will be auto-generated)

### 3. Deploy API Service

1. Click "+ New" → "GitHub Repo" → Select your repo again
2. Name this service "kazi-api"
3. Go to service Settings → set the following:

**Root Directory**: Leave empty (monorepo root)

**Build Command**:
```bash
npm install && npm run build:api
```

**Start Command**:
```bash
npm run start:api
```

**Environment Variables**:
```bash
DATABASE_URL=${{Postgres.DATABASE_URL}}
JWT_SECRET=your-super-secret-jwt-key-min-32-characters-long
JWT_REFRESH_SECRET=your-super-secret-refresh-key-min-32-characters-long
NODE_ENV=production
PORT=${{PORT}}
FRONTEND_URL=https://your-frontend-url.up.railway.app
RESEND_API_KEY=re_your_resend_api_key
EMAIL_FROM=Kazi <onboarding@yourdomain.com>
APP_URL=https://your-frontend-url.up.railway.app
```

4. Click "Deploy"

### 4. Deploy Web Service

1. Click "+ New" → "GitHub Repo" → Select your repo again
2. Name this service "kazi-web"
3. Go to service Settings → set the following:

**Root Directory**: Leave empty (monorepo root)

**Build Command**:
```bash
npm install && npm run build:web
```

**Start Command**:
```bash
npm run start:web
```

**Environment Variables**:
```bash
VITE_API_URL=https://your-api-url.up.railway.app
```

4. Click "Deploy"

### 5. Update Environment Variables

After both services deploy, you'll get their URLs:

1. Copy the API service URL (e.g., `https://kazi-api-production.up.railway.app`)
2. Go to Web service → Variables → Update `VITE_API_URL` with the API URL
3. Copy the Web service URL (e.g., `https://kazi-web-production.up.railway.app`)
4. Go to API service → Variables → Update `FRONTEND_URL` and `APP_URL` with the Web URL
5. Redeploy both services for changes to take effect

### 6. Set Up Custom Domains (Optional)

1. In each service, go to Settings → Domains
2. Click "Generate Domain" or add your custom domain
3. Update environment variables with the new domains

## Environment Variables Reference

### API Service

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | Auto-generated by Railway |
| `JWT_SECRET` | Secret for JWT tokens (min 32 chars) | Generate with `openssl rand -base64 32` |
| `JWT_REFRESH_SECRET` | Secret for refresh tokens (min 32 chars) | Generate with `openssl rand -base64 32` |
| `NODE_ENV` | Environment mode | `production` |
| `PORT` | Server port | Auto-set by Railway |
| `FRONTEND_URL` | Frontend URL for CORS | `https://your-app.up.railway.app` |
| `RESEND_API_KEY` | Resend API key for emails | Get from resend.com |
| `EMAIL_FROM` | Email sender address | `Kazi <onboarding@yourdomain.com>` |
| `APP_URL` | App URL for email links | Same as `FRONTEND_URL` |

### Web Service

| Variable | Description | Example |
|----------|-------------|---------|
| `VITE_API_URL` | Backend API URL | `https://your-api.up.railway.app` |

## Post-Deployment

### Run Database Migrations

Migrations run automatically on API service start via the `start:api` script.

To manually run migrations:
1. Go to API service → Settings
2. Open the service shell (terminal icon)
3. Run: `npm run db:migrate:deploy --workspace=apps/api`

### Seed Database (Optional)

To populate initial data:
1. Open API service shell
2. Run: `npm run db:seed --workspace=apps/api`

## Troubleshooting

### API Service Won't Start

- Check that `DATABASE_URL` is set correctly
- Verify all required environment variables are present
- Check deployment logs for Prisma migration errors

### Web Service Shows Blank Page

- Verify `VITE_API_URL` points to the correct API service URL
- Check browser console for CORS errors
- Ensure API's `FRONTEND_URL` includes the web service URL

### CORS Errors

- Make sure `FRONTEND_URL` in API service matches the web service URL exactly
- If using multiple domains, separate with commas: `https://app.com,https://www.app.com`

### Database Connection Issues

- Verify `DATABASE_URL` format is correct
- Check that PostgreSQL service is running
- Ensure Prisma migrations have run

## Monitoring

- Railway provides built-in logs and metrics
- Access logs via the service dashboard
- Set up alerts in Railway settings

## Updating the Application

1. Push changes to GitHub
2. Railway will automatically detect and redeploy
3. Monitor deployment in Railway dashboard

## Rollback

If a deployment fails:
1. Go to service → Deployments
2. Click on a previous successful deployment
3. Click "Redeploy"

## Support

- Railway Documentation: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Kazi Issues: https://github.com/draletilouis/Kazi/issues
